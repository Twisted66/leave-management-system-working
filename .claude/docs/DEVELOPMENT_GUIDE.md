# Development Guide

Comprehensive development guide for the Leave Management System.

## Directory Structure Explanation

### Frontend Build and Static Files

The project has three important directories related to frontend builds and static file serving:

#### 1. `frontend/dist/` 
- **Purpose**: Local development build output from Vite
- **Generated by**: `npm run build` in frontend directory
- **Content**: Compiled React application (HTML, CSS, JS bundles)
- **Usage**: Local testing and development builds
- **Git Status**: Should be ignored (`.gitignore`)

#### 2. `backend/frontend/`
- **Purpose**: Production frontend files served by Encore backend
- **Content**: Copy of compiled frontend for backend static serving
- **Generated by**: Build process that copies from `frontend/dist/`
- **Usage**: Encore serves these files at `/frontend/*` routes
- **Key Files**: 
  - `dist/` - Production frontend build
  - `encore.service.ts` - Encore service for static file serving

#### 3. `backend/static/` (if it exists)
- **Purpose**: Additional static assets served by backend
- **Content**: Non-frontend static files (images, documents, etc.)
- **Usage**: Backend-specific static assets

### Static File Serving Architecture

```
Frontend Development:
frontend/src/ → [Vite Build] → frontend/dist/

Production Deployment:
frontend/dist/ → [Copy] → backend/frontend/dist/ → [Encore Serves] → /frontend/*
```

### Encore Static File Routes

From `backend/frontend/encore.service.ts`:

1. **Assets Route**: `/frontend/assets/*path`
   - Serves compiled assets (CSS, JS, images) with proper MIME types
   - Maps to `dist/assets/` directory

2. **Frontend Route**: `/frontend/*path`
   - Serves HTML pages with SPA fallback
   - Maps to `dist/` directory
   - Falls back to `index.html` for client-side routing

3. **Root Fallback**: `/!path`
   - SPA routing fallback to `dist/index.html`
   - Handles React Router navigation

## Development Workflow

### Local Development

1. **Start Backend** (Terminal 1):
   ```bash
   cd backend
   encore run
   ```

2. **Start Frontend** (Terminal 2):
   ```bash
   cd frontend
   npm run dev
   ```

3. **Frontend Development Server**: http://localhost:5173
4. **Backend API**: http://localhost:4000
5. **Frontend via Backend**: http://localhost:4000/frontend/

### Production Build

1. **Build Frontend**:
   ```bash
   cd frontend
   npm run build
   ```

2. **Copy to Backend** (automated in build script):
   ```bash
   cd backend
   npm run build  # Builds frontend and places in backend/frontend/dist/
   ```

3. **Deploy Backend**:
   ```bash
   git push encore  # Deploys to Encore Cloud
   ```

## Key Configuration Files

### Vite Configuration (`frontend/vite.config.ts`)

```typescript
export default defineConfig({
  base: '/frontend/',  // Important: Base path for production
  build: {
    outDir: '../backend/frontend/dist',  // Build output location
    emptyOutDir: true
  },
  server: {
    headers: {
      'Content-Security-Policy': 'connect-src ... http://localhost:4000 ...'
    }
  }
})
```

### Package.json Build Scripts

**Root `package.json`**:
```json
{
  "scripts": {
    "build": "cd frontend && rm -rf node_modules && rm -rf dist && npm install --no-cache && npx vite build --outDir=../backend/frontend/dist --emptyOutDir"
  }
}
```

**Frontend `package.json`**:
```json
{
  "scripts": {
    "build": "vite build",
    "dev": "vite --host"
  }
}
```

## Environment Configuration

### Development (`.env`)
```bash
ENCORE_PORT=4000
API_BASE_URL=http://localhost:4000
VITE_CLIENT_TARGET=http://localhost:4000
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key
NODE_ENV=development
```

### Frontend Environment (`.env.development`)
```bash
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key
VITE_CLIENT_TARGET=http://localhost:4000
```

## API Client Configuration

The frontend uses a generated TypeScript client that automatically configures based on environment:

```typescript
// frontend/lib/client.ts
const getApiUrl = (): string => {
  if (typeof window === 'undefined') return process.env.VITE_CLIENT_TARGET || 'http://localhost:4000';
  
  const hostname = window.location.hostname;
  if (hostname === 'localhost' || hostname === '127.0.0.1') {
    return process.env.VITE_CLIENT_TARGET || 'http://localhost:4000';
  }
  
  // Production environment detection
  const envMatch = hostname.match(/^(.+)\.encr\.app$/);
  if (envMatch) {
    return `https://${envMatch[1]}.encr.app`;
  }
  
  return window.location.origin;
};
```

## Database Migrations

Encore uses numbered SQL migrations in `backend/leave/migrations/`:

```
1_initial_schema.up.sql
2_add_leave_types.up.sql
3_add_documents.up.sql
...
```

### Running Migrations
```bash
cd backend
encore db migrate
```

## Authentication Flow

1. **Supabase Authentication**: Frontend handles login/signup
2. **JWT Token**: Supabase provides JWT token
3. **Backend Sync**: Frontend syncs user to internal database
4. **API Calls**: All API calls include JWT in Authorization header

## Common Development Tasks

### Regenerate Frontend Client
```bash
cd backend
encore gen client --target leap  # Generates frontend/client.ts
```

### Add New API Endpoint
1. Add endpoint to backend service file
2. Regenerate client: `encore gen client --target leap`
3. Use new endpoint in frontend components

### Add New Database Table
1. Create migration file: `backend/leave/migrations/N_description.up.sql`
2. Run migration: `encore db migrate`
3. Update TypeScript types in `backend/leave/types.ts`

### Update UI Components
1. Components in `frontend/components/`
2. Use existing UI library components from `frontend/components/ui/`
3. Follow existing patterns for dialogs, forms, tables

## Troubleshooting

### Common Issues

1. **CORS Errors**: Check CSP policy in `vite.config.ts`
2. **Authentication Errors**: Verify Supabase keys in `.env.development`
3. **Build Failures**: Ensure clean install with `rm -rf node_modules`
4. **API Client Issues**: Regenerate client after backend changes
5. **Static File 404s**: Check build output directory and Encore routes

### Debug Commands

```bash
# Check backend health
curl http://localhost:4000/admin/health

# Test API endpoint
curl -H "Authorization: Bearer <token>" http://localhost:4000/employees

# Check frontend build
ls -la frontend/dist/
ls -la backend/frontend/dist/

# View logs
encore logs --local
```

## Testing

### Running Tests
```bash
# Backend tests
cd backend
encore test

# Frontend tests
cd frontend
npm test
```

### Test Database
Encore automatically creates test database for testing.

## Deployment

### Encore Cloud Deployment
```bash
encore auth login
git remote add encore encore://leave-management-system-99ki
git push encore
```

### Environment Variables (Production)
Set in Encore dashboard:
- `SUPABASE_URL`
- `SUPABASE_ANON_KEY`
- Database connection strings (automatic)

---

*Last Updated: December 2024*
*Version: 1.0*